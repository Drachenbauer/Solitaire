[gd_scene load_steps=4 format=2]

[ext_resource path="res://assets/style/Style.tres" type="Theme" id=1]
[ext_resource path="res://assets/graphics/suits 1.png" type="Texture" id=2]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D


# Declare member variables here:
const SUITS = {\"h\" : 0, \"d\" : 2, \"s\" : 4, \"c\" : 6}
const VALUES = [\"a\", 2, 3, 4, 5, 6, 7, 8, 9, 10, \"j\", \"q\", \"k\"]

onready var card_path = preload(\"Card.tscn\")
onready var deck = $Deck
onready var storage = $Deck/Storage
onready var flip_open = $Deck/FlipOpen
onready var targets = [$Deck/TargetHearts, $Deck/TargetDiamonds, $Deck/TargetSpades, $Deck/TargetClubs]
onready var bottom = [$Deck/Bottom1, $Deck/Bottom2, $Deck/Bottom3, $Deck/Bottom4, $Deck/Bottom5, $Deck/Bottom6, $Deck/Bottom7]

# Called when the node enters the scene tree for the first time.
func _ready():
	generate_deck()
	shuffle_deck()
	put_deck_on_storage()
	deal_bottom_stacks()


func generate_deck():
	for suit in SUITS:
		for value in VALUES:
			var value_id = VALUES.find(value)
			var coord_base
			
			if value_id < 10:
				coord_base = Vector2(value_id, 0)
			else:
				coord_base = Vector2(value_id - 10, 1)
			
			var id = coord_base + Vector2(0, SUITS[suit])
			var card = card_path.instance()
			card.suit = SUITS[suit]
			card.value = value
			card.id = id
			G.storage_stack.append(card)


func shuffle_deck():
	randomize()
	G.storage_stack.shuffle()


func put_deck_on_storage():
	for card in G.storage_stack:
		storage.add_child(card)
		card.set_card_type()
		card.connect(\"flipped\", self, \"_is_card_flipped\") 


func deal_bottom_stacks():
	var i = 0
	
	for stack in G.bottom_stacks:
		i += 1
		
		for j in range(i):
			var card = G.storage_stack[G.storage_stack.size()-1]
			card.change_parent(bottom[G.bottom_stacks.find(stack)])
			card.position.y = (stack.size() * 8)
			stack.append(card)
			G.storage_stack.erase(card)
			
			
			if j == i - 1:
				card.show_front()
				card.is_on_top = true
	
	G.storage_stack[G.storage_stack.size() - 1].is_on_top = true


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(_delta):
	cards_back_to_storage()
	G.is_card_flipped = false


func _is_card_flipped():
	G.is_card_flipped = true


func cards_back_to_storage():
	if !G.is_card_flipped && !G.is_card_sliding && G.storage_stack.size() == 0:
		var click_position = get_viewport().get_mouse_position()
		
		if click_position.x > 16 && click_position.x < 89:
			if click_position.y > 16 && click_position.y < 113:
				if Input.is_action_just_pressed(\"Click\"):
					G.storage_stack = G.flip_open_stack.duplicate()
					G.flip_open_stack.clear()
					G.storage_stack.invert()
					
					for card in G.storage_stack:
						card.change_parent(storage)
						card.show_back()
"

[node name="Game" type="Node2D" groups=["table"]]
script = SubResource( 1 )

[node name="Background" type="Panel" parent="."]
margin_right = 728.0
margin_bottom = 520.0
mouse_filter = 2
theme = ExtResource( 1 )

[node name="Panel" type="Panel" parent="Background"]
margin_left = 16.0
margin_top = 16.0
margin_right = 88.0
margin_bottom = 112.0
mouse_filter = 2

[node name="Panel2" type="Panel" parent="Background"]
margin_left = 120.0
margin_top = 16.0
margin_right = 192.0
margin_bottom = 112.0
mouse_filter = 2

[node name="Panel3" type="Panel" parent="Background"]
margin_left = 328.0
margin_top = 16.0
margin_right = 400.0
margin_bottom = 112.0
mouse_filter = 2

[node name="Hearts" type="Sprite" parent="Background/Panel3"]
position = Vector2( 36, 48 )
texture = ExtResource( 2 )
region_enabled = true
region_rect = Rect2( 0, 0, 16, 16 )

[node name="Panel4" type="Panel" parent="Background"]
margin_left = 432.0
margin_top = 16.0
margin_right = 504.0
margin_bottom = 112.0
mouse_filter = 2

[node name="Diamonds" type="Sprite" parent="Background/Panel4"]
position = Vector2( 36, 48 )
texture = ExtResource( 2 )
region_enabled = true
region_rect = Rect2( 16, 0, 16, 16 )

[node name="Panel5" type="Panel" parent="Background"]
margin_left = 536.0
margin_top = 16.0
margin_right = 608.0
margin_bottom = 112.0
mouse_filter = 2

[node name="Spades" type="Sprite" parent="Background/Panel5"]
position = Vector2( 36, 48 )
texture = ExtResource( 2 )
region_enabled = true
region_rect = Rect2( 0, 16, 16, 16 )

[node name="Panel6" type="Panel" parent="Background"]
margin_left = 640.0
margin_top = 16.0
margin_right = 712.0
margin_bottom = 112.0
mouse_filter = 2

[node name="Clubs" type="Sprite" parent="Background/Panel6"]
position = Vector2( 36, 48 )
texture = ExtResource( 2 )
region_enabled = true
region_rect = Rect2( 16, 16, 16, 16 )

[node name="Deck" type="Node2D" parent="."]
position = Vector2( 52, 64 )

[node name="Storage" type="Node2D" parent="Deck"]

[node name="FlipOpen" type="Node2D" parent="Deck"]
position = Vector2( 104, 0 )
rotation = -0.00234827

[node name="TargetHearts" type="Node2D" parent="Deck"]
position = Vector2( 312, 0 )

[node name="TargetDiamonds" type="Node2D" parent="Deck"]
position = Vector2( 416, 0 )
rotation = 0.00124177

[node name="TargetSpades" type="Node2D" parent="Deck"]
position = Vector2( 520, 0 )

[node name="TargetClubs" type="Node2D" parent="Deck"]
position = Vector2( 624, 0 )

[node name="Bottom1" type="Node2D" parent="Deck"]
position = Vector2( 0, 128 )

[node name="Bottom2" type="Node2D" parent="Deck"]
position = Vector2( 104, 128 )

[node name="Bottom3" type="Node2D" parent="Deck"]
position = Vector2( 208, 128 )

[node name="Bottom4" type="Node2D" parent="Deck"]
position = Vector2( 312, 128 )

[node name="Bottom5" type="Node2D" parent="Deck"]
position = Vector2( 416, 128 )

[node name="Bottom6" type="Node2D" parent="Deck"]
position = Vector2( 520, 128 )

[node name="Bottom7" type="Node2D" parent="Deck"]
position = Vector2( 623, 128 )
